.ORIG	x0000
; Trap vector table
    .FILL BAD_TRAP ; x0000
    .FILL BAD_TRAP ; x0001
    .FILL BAD_TRAP ; x0002
    .FILL BAD_TRAP ; x0003
    .FILL BAD_TRAP ; x0004
    .FILL BAD_TRAP ; x0005
    .FILL BAD_TRAP ; x0006
    .FILL BAD_TRAP ; x0007
    .FILL BAD_TRAP ; x0008
    .FILL BAD_TRAP ; x0009
    .FILL BAD_TRAP ; x000A
    .FILL BAD_TRAP ; x000B
    .FILL BAD_TRAP ; x000C
    .FILL BAD_TRAP ; x000D
    .FILL BAD_TRAP ; x000E
    .FILL BAD_TRAP ; x000F
    .FILL TRAP_PUTS ; x0010
    .FILL BAD_TRAP ; x0011
    .FILL BAD_TRAP ; x0012
    .FILL BAD_TRAP ; x0013
    .FILL BAD_TRAP ; x0014
    .FILL BAD_TRAP ; x0015
    .FILL BAD_TRAP ; x0016
    .FILL BAD_TRAP ; x0017
    .FILL BAD_TRAP ; x0018
    .FILL BAD_TRAP ; x0019
    .FILL BAD_TRAP ; x001A
    .FILL BAD_TRAP ; x001B
    .FILL BAD_TRAP ; x001C
    .FILL BAD_TRAP ; x001D
    .FILL BAD_TRAP ; x001E
    .FILL BAD_TRAP ; x001F
    .FILL BAD_TRAP ; x0020
    .FILL BAD_TRAP ; x0021
    .FILL BAD_TRAP ; x0022
    .FILL BAD_TRAP ; x0023
    .FILL BAD_TRAP ; x0024
    .FILL BAD_TRAP ; x0025
    .FILL BAD_TRAP ; x0026
    .FILL BAD_TRAP ; x0027
    .FILL BAD_TRAP ; x0028
    .FILL BAD_TRAP ; x0029
    .FILL BAD_TRAP ; x002A
    .FILL BAD_TRAP ; x002B
    .FILL BAD_TRAP ; x002C
    .FILL BAD_TRAP ; x002D
    .FILL BAD_TRAP ; x002E
    .FILL BAD_TRAP ; x002F
    .FILL BAD_TRAP ; x0030
    .FILL BAD_TRAP ; x0031
    .FILL BAD_TRAP ; x0032
    .FILL BAD_TRAP ; x0033
    .FILL BAD_TRAP ; x0034
    .FILL BAD_TRAP ; x0035
    .FILL BAD_TRAP ; x0036
    .FILL BAD_TRAP ; x0037
    .FILL BAD_TRAP ; x0038
    .FILL BAD_TRAP ; x0039
    .FILL BAD_TRAP ; x003A
    .FILL BAD_TRAP ; x003B
    .FILL BAD_TRAP ; x003C
    .FILL BAD_TRAP ; x003D
    .FILL BAD_TRAP ; x003E
    .FILL BAD_TRAP ; x003F
    .FILL BAD_TRAP ; x0040
    .FILL BAD_TRAP ; x0041
    .FILL BAD_TRAP ; x0042
    .FILL BAD_TRAP ; x0043
    .FILL BAD_TRAP ; x0044
    .FILL BAD_TRAP ; x0045
    .FILL BAD_TRAP ; x0046
    .FILL BAD_TRAP ; x0047
    .FILL BAD_TRAP ; x0048
    .FILL BAD_TRAP ; x0049
    .FILL BAD_TRAP ; x004A
    .FILL BAD_TRAP ; x004B
    .FILL BAD_TRAP ; x004C
    .FILL BAD_TRAP ; x004D
    .FILL BAD_TRAP ; x004E
    .FILL BAD_TRAP ; x004F
    .FILL BAD_TRAP ; x0050
    .FILL BAD_TRAP ; x0051
    .FILL BAD_TRAP ; x0052
    .FILL BAD_TRAP ; x0053
    .FILL BAD_TRAP ; x0054
    .FILL BAD_TRAP ; x0055
    .FILL BAD_TRAP ; x0056
    .FILL BAD_TRAP ; x0057
    .FILL BAD_TRAP ; x0058
    .FILL BAD_TRAP ; x0059
    .FILL BAD_TRAP ; x005A
    .FILL BAD_TRAP ; x005B
    .FILL BAD_TRAP ; x005C
    .FILL BAD_TRAP ; x005D
    .FILL BAD_TRAP ; x005E
    .FILL BAD_TRAP ; x005F
    .FILL BAD_TRAP ; x0060
    .FILL BAD_TRAP ; x0061
    .FILL BAD_TRAP ; x0062
    .FILL BAD_TRAP ; x0063
    .FILL BAD_TRAP ; x0064
    .FILL BAD_TRAP ; x0065
    .FILL BAD_TRAP ; x0066
    .FILL BAD_TRAP ; x0067
    .FILL BAD_TRAP ; x0068
    .FILL BAD_TRAP ; x0069
    .FILL BAD_TRAP ; x006A
    .FILL BAD_TRAP ; x006B
    .FILL BAD_TRAP ; x006C
    .FILL BAD_TRAP ; x006D
    .FILL BAD_TRAP ; x006E
    .FILL BAD_TRAP ; x006F
    .FILL BAD_TRAP ; x0070
    .FILL BAD_TRAP ; x0071
    .FILL BAD_TRAP ; x0072
    .FILL BAD_TRAP ; x0073
    .FILL BAD_TRAP ; x0074
    .FILL BAD_TRAP ; x0075
    .FILL BAD_TRAP ; x0076
    .FILL BAD_TRAP ; x0077
    .FILL BAD_TRAP ; x0078
    .FILL BAD_TRAP ; x0079
    .FILL BAD_TRAP ; x007A
    .FILL BAD_TRAP ; x007B
    .FILL BAD_TRAP ; x007C
    .FILL BAD_TRAP ; x007D
    .FILL BAD_TRAP ; x007E
    .FILL BAD_TRAP ; x007F
    .FILL BAD_TRAP ; x0080
    .FILL BAD_TRAP ; x0081
    .FILL BAD_TRAP ; x0082
    .FILL BAD_TRAP ; x0083
    .FILL BAD_TRAP ; x0084
    .FILL BAD_TRAP ; x0085
    .FILL BAD_TRAP ; x0086
    .FILL BAD_TRAP ; x0087
    .FILL BAD_TRAP ; x0088
    .FILL BAD_TRAP ; x0089
    .FILL BAD_TRAP ; x008A
    .FILL BAD_TRAP ; x008B
    .FILL BAD_TRAP ; x008C
    .FILL BAD_TRAP ; x008D
    .FILL BAD_TRAP ; x008E
    .FILL BAD_TRAP ; x008F
    .FILL BAD_TRAP ; x0090
    .FILL BAD_TRAP ; x0091
    .FILL BAD_TRAP ; x0092
    .FILL BAD_TRAP ; x0093
    .FILL BAD_TRAP ; x0094
    .FILL BAD_TRAP ; x0095
    .FILL BAD_TRAP ; x0096
    .FILL BAD_TRAP ; x0097
    .FILL BAD_TRAP ; x0098
    .FILL BAD_TRAP ; x0099
    .FILL BAD_TRAP ; x009A
    .FILL BAD_TRAP ; x009B
    .FILL BAD_TRAP ; x009C
    .FILL BAD_TRAP ; x009D
    .FILL BAD_TRAP ; x009E
    .FILL BAD_TRAP ; x009F
    .FILL BAD_TRAP ; x00A0
    .FILL BAD_TRAP ; x00A1
    .FILL BAD_TRAP ; x00A2
    .FILL BAD_TRAP ; x00A3
    .FILL BAD_TRAP ; x00A4
    .FILL BAD_TRAP ; x00A5
    .FILL BAD_TRAP ; x00A6
    .FILL BAD_TRAP ; x00A7
    .FILL BAD_TRAP ; x00A8
    .FILL BAD_TRAP ; x00A9
    .FILL BAD_TRAP ; x00AA
    .FILL BAD_TRAP ; x00AB
    .FILL BAD_TRAP ; x00AC
    .FILL BAD_TRAP ; x00AD
    .FILL BAD_TRAP ; x00AE
    .FILL BAD_TRAP ; x00AF
    .FILL BAD_TRAP ; x00B0
    .FILL BAD_TRAP ; x00B1
    .FILL BAD_TRAP ; x00B2
    .FILL BAD_TRAP ; x00B3
    .FILL BAD_TRAP ; x00B4
    .FILL BAD_TRAP ; x00B5
    .FILL BAD_TRAP ; x00B6
    .FILL BAD_TRAP ; x00B7
    .FILL BAD_TRAP ; x00B8
    .FILL BAD_TRAP ; x00B9
    .FILL BAD_TRAP ; x00BA
    .FILL BAD_TRAP ; x00BB
    .FILL BAD_TRAP ; x00BC
    .FILL BAD_TRAP ; x00BD
    .FILL BAD_TRAP ; x00BE
    .FILL BAD_TRAP ; x00BF
    .FILL BAD_TRAP ; x00C0
    .FILL BAD_TRAP ; x00C1
    .FILL BAD_TRAP ; x00C2
    .FILL BAD_TRAP ; x00C3
    .FILL BAD_TRAP ; x00C4
    .FILL BAD_TRAP ; x00C5
    .FILL BAD_TRAP ; x00C6
    .FILL BAD_TRAP ; x00C7
    .FILL BAD_TRAP ; x00C8
    .FILL BAD_TRAP ; x00C9
    .FILL BAD_TRAP ; x00CA
    .FILL BAD_TRAP ; x00CB
    .FILL BAD_TRAP ; x00CC
    .FILL BAD_TRAP ; x00CD
    .FILL BAD_TRAP ; x00CE
    .FILL BAD_TRAP ; x00CF
    .FILL BAD_TRAP ; x00D0
    .FILL BAD_TRAP ; x00D1
    .FILL BAD_TRAP ; x00D2
    .FILL BAD_TRAP ; x00D3
    .FILL BAD_TRAP ; x00D4
    .FILL BAD_TRAP ; x00D5
    .FILL BAD_TRAP ; x00D6
    .FILL BAD_TRAP ; x00D7
    .FILL BAD_TRAP ; x00D8
    .FILL BAD_TRAP ; x00D9
    .FILL BAD_TRAP ; x00DA
    .FILL BAD_TRAP ; x00DB
    .FILL BAD_TRAP ; x00DC
    .FILL BAD_TRAP ; x00DD
    .FILL BAD_TRAP ; x00DE
    .FILL BAD_TRAP ; x00DF
    .FILL BAD_TRAP ; x00E0
    .FILL BAD_TRAP ; x00E1
    .FILL BAD_TRAP ; x00E2
    .FILL BAD_TRAP ; x00E3
    .FILL BAD_TRAP ; x00E4
    .FILL BAD_TRAP ; x00E5
    .FILL BAD_TRAP ; x00E6
    .FILL BAD_TRAP ; x00E7
    .FILL BAD_TRAP ; x00E8
    .FILL BAD_TRAP ; x00E9
    .FILL BAD_TRAP ; x00EA
    .FILL BAD_TRAP ; x00EB
    .FILL BAD_TRAP ; x00EC
    .FILL BAD_TRAP ; x00ED
    .FILL BAD_TRAP ; x00EE
    .FILL BAD_TRAP ; x00EF
    .FILL BAD_TRAP ; x00F0
    .FILL BAD_TRAP ; x00F1
    .FILL BAD_TRAP ; x00F2
    .FILL BAD_TRAP ; x00F3
    .FILL BAD_TRAP ; x00F4
    .FILL BAD_TRAP ; x00F5
    .FILL BAD_TRAP ; x00F6
    .FILL BAD_TRAP ; x00F7
    .FILL BAD_TRAP ; x00F8
    .FILL BAD_TRAP ; x00F9
    .FILL BAD_TRAP ; x00FA
    .FILL BAD_TRAP ; x00FB
    .FILL BAD_TRAP ; x00FC
    .FILL BAD_TRAP ; x00FD
    .FILL BAD_TRAP ; x00FE
    .FILL BAD_TRAP ; x00FF

; Interrupt Vector Table
    .FILL BAD_INT ; x0100
    .FILL BAD_INT ; x0101
    .FILL BAD_INT ; x0102
    .FILL BAD_INT ; x0103
    .FILL BAD_INT ; x0104
    .FILL BAD_INT ; x0105
    .FILL BAD_INT ; x0106
    .FILL BAD_INT ; x0107
    .FILL BAD_INT ; x0108
    .FILL BAD_INT ; x0109
    .FILL BAD_INT ; x010A
    .FILL BAD_INT ; x010B
    .FILL BAD_INT ; x010C
    .FILL BAD_INT ; x010D
    .FILL BAD_INT ; x010E
    .FILL BAD_INT ; x010F
    .FILL BAD_INT ; x0110
    .FILL BAD_INT ; x0111
    .FILL BAD_INT ; x0112
    .FILL BAD_INT ; x0113
    .FILL BAD_INT ; x0114
    .FILL BAD_INT ; x0115
    .FILL BAD_INT ; x0116
    .FILL BAD_INT ; x0117
    .FILL BAD_INT ; x0118
    .FILL BAD_INT ; x0119
    .FILL BAD_INT ; x011A
    .FILL BAD_INT ; x011B
    .FILL BAD_INT ; x011C
    .FILL BAD_INT ; x011D
    .FILL BAD_INT ; x011E
    .FILL BAD_INT ; x011F
    .FILL BAD_INT ; x0120
    .FILL BAD_INT ; x0121
    .FILL BAD_INT ; x0122
    .FILL BAD_INT ; x0123
    .FILL BAD_INT ; x0124
    .FILL BAD_INT ; x0125
    .FILL BAD_INT ; x0126
    .FILL BAD_INT ; x0127
    .FILL BAD_INT ; x0128
    .FILL BAD_INT ; x0129
    .FILL BAD_INT ; x012A
    .FILL BAD_INT ; x012B
    .FILL BAD_INT ; x012C
    .FILL BAD_INT ; x012D
    .FILL BAD_INT ; x012E
    .FILL BAD_INT ; x012F
    .FILL BAD_INT ; x0130
    .FILL BAD_INT ; x0131
    .FILL BAD_INT ; x0132
    .FILL BAD_INT ; x0133
    .FILL BAD_INT ; x0134
    .FILL BAD_INT ; x0135
    .FILL BAD_INT ; x0136
    .FILL BAD_INT ; x0137
    .FILL BAD_INT ; x0138
    .FILL BAD_INT ; x0139
    .FILL BAD_INT ; x013A
    .FILL BAD_INT ; x013B
    .FILL BAD_INT ; x013C
    .FILL BAD_INT ; x013D
    .FILL BAD_INT ; x013E
    .FILL BAD_INT ; x013F
    .FILL BAD_INT ; x0140
    .FILL BAD_INT ; x0141
    .FILL BAD_INT ; x0142
    .FILL BAD_INT ; x0143
    .FILL BAD_INT ; x0144
    .FILL BAD_INT ; x0145
    .FILL BAD_INT ; x0146
    .FILL BAD_INT ; x0147
    .FILL BAD_INT ; x0148
    .FILL BAD_INT ; x0149
    .FILL BAD_INT ; x014A
    .FILL BAD_INT ; x014B
    .FILL BAD_INT ; x014C
    .FILL BAD_INT ; x014D
    .FILL BAD_INT ; x014E
    .FILL BAD_INT ; x014F
    .FILL BAD_INT ; x0150
    .FILL BAD_INT ; x0151
    .FILL BAD_INT ; x0152
    .FILL BAD_INT ; x0153
    .FILL BAD_INT ; x0154
    .FILL BAD_INT ; x0155
    .FILL BAD_INT ; x0156
    .FILL BAD_INT ; x0157
    .FILL BAD_INT ; x0158
    .FILL BAD_INT ; x0159
    .FILL BAD_INT ; x015A
    .FILL BAD_INT ; x015B
    .FILL BAD_INT ; x015C
    .FILL BAD_INT ; x015D
    .FILL BAD_INT ; x015E
    .FILL BAD_INT ; x015F
    .FILL BAD_INT ; x0160
    .FILL BAD_INT ; x0161
    .FILL BAD_INT ; x0162
    .FILL BAD_INT ; x0163
    .FILL BAD_INT ; x0164
    .FILL BAD_INT ; x0165
    .FILL BAD_INT ; x0166
    .FILL BAD_INT ; x0167
    .FILL BAD_INT ; x0168
    .FILL BAD_INT ; x0169
    .FILL BAD_INT ; x016A
    .FILL BAD_INT ; x016B
    .FILL BAD_INT ; x016C
    .FILL BAD_INT ; x016D
    .FILL BAD_INT ; x016E
    .FILL BAD_INT ; x016F
    .FILL BAD_INT ; x0170
    .FILL BAD_INT ; x0171
    .FILL BAD_INT ; x0172
    .FILL BAD_INT ; x0173
    .FILL BAD_INT ; x0174
    .FILL BAD_INT ; x0175
    .FILL BAD_INT ; x0176
    .FILL BAD_INT ; x0177
    .FILL BAD_INT ; x0178
    .FILL BAD_INT ; x0179
    .FILL BAD_INT ; x017A
    .FILL BAD_INT ; x017B
    .FILL BAD_INT ; x017C
    .FILL BAD_INT ; x017D
    .FILL BAD_INT ; x017E
    .FILL BAD_INT ; x017F
    .FILL BAD_INT ; x0180
    .FILL BAD_INT ; x0181
    .FILL BAD_INT ; x0182
    .FILL BAD_INT ; x0183
    .FILL BAD_INT ; x0184
    .FILL BAD_INT ; x0185
    .FILL BAD_INT ; x0186
    .FILL BAD_INT ; x0187
    .FILL BAD_INT ; x0188
    .FILL BAD_INT ; x0189
    .FILL BAD_INT ; x018A
    .FILL BAD_INT ; x018B
    .FILL BAD_INT ; x018C
    .FILL BAD_INT ; x018D
    .FILL BAD_INT ; x018E
    .FILL BAD_INT ; x018F
    .FILL BAD_INT ; x0190
    .FILL BAD_INT ; x0191
    .FILL BAD_INT ; x0192
    .FILL BAD_INT ; x0193
    .FILL BAD_INT ; x0194
    .FILL BAD_INT ; x0195
    .FILL BAD_INT ; x0196
    .FILL BAD_INT ; x0197
    .FILL BAD_INT ; x0198
    .FILL BAD_INT ; x0199
    .FILL BAD_INT ; x019A
    .FILL BAD_INT ; x019B
    .FILL BAD_INT ; x019C
    .FILL BAD_INT ; x019D
    .FILL BAD_INT ; x019E
    .FILL BAD_INT ; x019F
    .FILL BAD_INT ; x01A0
    .FILL BAD_INT ; x01A1
    .FILL BAD_INT ; x01A2
    .FILL BAD_INT ; x01A3
    .FILL BAD_INT ; x01A4
    .FILL BAD_INT ; x01A5
    .FILL BAD_INT ; x01A6
    .FILL BAD_INT ; x01A7
    .FILL BAD_INT ; x01A8
    .FILL BAD_INT ; x01A9
    .FILL BAD_INT ; x01AA
    .FILL BAD_INT ; x01AB
    .FILL BAD_INT ; x01AC
    .FILL BAD_INT ; x01AD
    .FILL BAD_INT ; x01AE
    .FILL BAD_INT ; x01AF
    .FILL BAD_INT ; x01B0
    .FILL BAD_INT ; x01B1
    .FILL BAD_INT ; x01B2
    .FILL BAD_INT ; x01B3
    .FILL BAD_INT ; x01B4
    .FILL BAD_INT ; x01B5
    .FILL BAD_INT ; x01B6
    .FILL BAD_INT ; x01B7
    .FILL BAD_INT ; x01B8
    .FILL BAD_INT ; x01B9
    .FILL BAD_INT ; x01BA
    .FILL BAD_INT ; x01BB
    .FILL BAD_INT ; x01BC
    .FILL BAD_INT ; x01BD
    .FILL BAD_INT ; x01BE
    .FILL BAD_INT ; x01BF
    .FILL BAD_INT ; x01C0
    .FILL BAD_INT ; x01C1
    .FILL BAD_INT ; x01C2
    .FILL BAD_INT ; x01C3
    .FILL BAD_INT ; x01C4
    .FILL BAD_INT ; x01C5
    .FILL BAD_INT ; x01C6
    .FILL BAD_INT ; x01C7
    .FILL BAD_INT ; x01C8
    .FILL BAD_INT ; x01C9
    .FILL BAD_INT ; x01CA
    .FILL BAD_INT ; x01CB
    .FILL BAD_INT ; x01CC
    .FILL BAD_INT ; x01CD
    .FILL BAD_INT ; x01CE
    .FILL BAD_INT ; x01CF
    .FILL BAD_INT ; x01D0
    .FILL BAD_INT ; x01D1
    .FILL BAD_INT ; x01D2
    .FILL BAD_INT ; x01D3
    .FILL BAD_INT ; x01D4
    .FILL BAD_INT ; x01D5
    .FILL BAD_INT ; x01D6
    .FILL BAD_INT ; x01D7
    .FILL BAD_INT ; x01D8
    .FILL BAD_INT ; x01D9
    .FILL BAD_INT ; x01DA
    .FILL BAD_INT ; x01DB
    .FILL BAD_INT ; x01DC
    .FILL BAD_INT ; x01DD
    .FILL BAD_INT ; x01DE
    .FILL BAD_INT ; x01DF
    .FILL BAD_INT ; x01E0
    .FILL BAD_INT ; x01E1
    .FILL BAD_INT ; x01E2
    .FILL BAD_INT ; x01E3
    .FILL BAD_INT ; x01E4
    .FILL BAD_INT ; x01E5
    .FILL BAD_INT ; x01E6
    .FILL BAD_INT ; x01E7
    .FILL BAD_INT ; x01E8
    .FILL BAD_INT ; x01E9
    .FILL BAD_INT ; x01EA
    .FILL BAD_INT ; x01EB
    .FILL BAD_INT ; x01EC
    .FILL BAD_INT ; x01ED
    .FILL BAD_INT ; x01EE
    .FILL BAD_INT ; x01EF
    .FILL BAD_INT ; x01F0
    .FILL BAD_INT ; x01F1
    .FILL BAD_INT ; x01F2
    .FILL BAD_INT ; x01F3
    .FILL BAD_INT ; x01F4
    .FILL BAD_INT ; x01F5
    .FILL BAD_INT ; x01F6
    .FILL BAD_INT ; x01F7
    .FILL BAD_INT ; x01F8
    .FILL BAD_INT ; x01F9
    .FILL BAD_INT ; x01FA
    .FILL BAD_INT ; x01FB
    .FILL BAD_INT ; x01FC
    .FILL BAD_INT ; x01FD
    .FILL BAD_INT ; x01FE
    .FILL BAD_INT ; x01FF


OS_BOOT 
        ; setup memory protection
        LD R0 MPR_INIT  ; load the value we want to save in MPR into R0
        STI	R0,	MPR_LOC ; store the value stored in R0 to where MPR_LOC is pointing to

        ; set timer interval
        LD R0 TMI_INIT
        STI R0, TMI_LOC

        ; jmp to user code
        LD R0, USER_CODE_ADDR ; load the user address into R0
        JMPT R0 ; jump to the user address code


USER_CODE_ADDR  .FILL x3000     ; User code address
PSR_LOC         .FILL xFFFC     ; PSR_LOC pointer to PSR
MPR_LOC         .FILL xFE12     ; MPR_LOC pointer to MPR
TMI_LOC         .FILL xFE0A     ; TMI_LOC pointer to TMI register
KBSR_LOC	    .FILL xFE00		; keyboard status register
KBDR_LOC	    .FILL xFE02		; keyboard data register
DSR_LOC	        .FILL xFE04		; display status register
DDR_LOC	        .FILL xFE06		; display data register
TMR_LOC	        .FILL xFE08		; timer register
MCR_LOC	        .FILL xFFFE		; machine control register

; MPR INIT holds the value that should be loaded by the OS into the MPR
MPR_INIT .FILL x0FF8 ; user can only access from x3000 to xbfff
; TMI_INIT value that should be loaded into TMI register
TMI_INIT .FILL #1000 ; interval every 10 milli seconds
; KBSR_INIT value that should be loaded into KBSR
KBSR_INIT .FILL x4000 ; enable interrupt

; push data onto the stack
; R6 holds the location of the top of the stack (i.e stack pointer)
; to push we decrease the stack pointer by 1 and add the value 
; to be pushed to the location.
PUSH    ADD	R6,	R6,	#-1 ; store the next lower memory location in R6
        STR R5,	R6, #0 ; store R5 in the top of the stack
        RET ; return from the call to push

; pop data from the stack
; R6 holds the top of the stack (i.e stack pointer)
; to pop the data we load from the top of the stack into R5
; and we increase the value of R6 by 1 showing the stack pointer has decrased
POP     LDR	R5,	R6,	#0 ; load into RO whatever memory adress R6 is pointing to
        ADD R6, R6, #1 ; increase stack pointer
        RET ; return from the call to pop

TRAP_PUTS
        ; 1.  save R5 in memory
        ; 2.  save R1 on supervisor stack
        ; 3.  save R2 on supervisor stack
        ; 4.  save R3 on supervisor stack
        ; 4.  minus R0 by  1 and store in R1
        ; 5.  Add 1 to R1
        ; 6.  Load character stored in location pointed to by R1 in R2
        ; 7.  Check if character is string termination
        ; 8.  If it is termination, perform return routine
        ; 9.  If not, load DSR into R3
        ; 10. Check if DSR is ready
        ; 11. If it is ready, load R2 into DDR and go to 5
        ; 12. If not, go to 9
        ; ================ Return Routine =================
        ; restore R5
        ; restore R3 from stack
        ; restore R2 from stack
        ; restore R1 from stack
        ; return from interrupt
        ST	R5,	SAVE_R5 ; save R5 in memory because we need R5 for stack operations
        AND R5, R5, #0 ; clear R5
        ADD	R5,	R5, R1 ; store R1 in R5
        JSR PUSH ; push R1 to stack
        AND R5, R5, #0 ; clear R5
        ADD	R5,	R5, R2 ; store R2 in R5
        JSR PUSH ; push R2 to stack
        AND R5, R5, #0 ; clear R5
        ADD	R5,	R5, R3 ; store R3 in R5
        JSR PUSH ; push R3 to stack
        ADD	R1,	R0,	#-1 ; minus 1 from R0 and store in R1
DISPLAY
        ADD R1, R1, #1 ; add 1 to R1
        LDR	R2,	R1,	#0 ; load R2 with value pointed by R1
        BRz RET_TRAP_PUTS ; return from this routine
CHECK_DISPLAY 
        LD	R3,	DSR_LOC ; load dsr into R
        BRn DISPLAYC ; display character if display is ready
        BRzp CHECK_DISPLAY ; otherwise check display again
DISPLAYC 
        STI	R2,	DDR_LOC ; store R2 into the display data register
        BRnzp DISPLAY ; go run display
RET_TRAP_PUTS
    AND R3, R3, #0 ; clear R3
    JSR POP        ; load R3 from stack
    ADD R3, R3, R5 ; store R5 (value popped from stack) into R3
    AND R2, R2, #0 ; clear R2
    JSR POP        ; pop R2 from stack
    ADD R2, R2, R5 ; store R5 in R2
    AND R1, R1, #0 ; clear R1
    JSR POP        ; pop R1 from the stack
    ADD R1, R1, R5 ; store R5 in R1
    LD	R5,	SAVE_R5 ; restore R5 from memory



SAVE_R5 .BLKW	1

; TODO Handle invalid system call. Ideally we should halt the CPU
BAD_TRAP ADD    R0,	R0,	#0 ; Add 0 to R0 essentially leave it unchanged
; TODO Handle invalid interrupt.
BAD_INT  ADD    R0, R0, #0 ; Add 0 to R0 essentially leave it unchanged
.END